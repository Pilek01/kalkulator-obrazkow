<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTREX - Kalkulatory Produkcji</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #ff6b35;
            --accent-hover: #ff8555;
            --border: #404040;
            --success: #4caf50;
            --danger: #f44336;
        }

        body.light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #cccccc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .content-wrapper {
            flex: 1;
        }

        /* Header with Tab Switcher */
        .header {
            background: var(--bg-secondary);
            border-bottom: 3px solid var(--accent);
            padding: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        /* Tab Switcher */
        .tab-switcher {
            display: flex;
            gap: 1rem;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 10px;
            border: 2px solid var(--border);
        }

        .tab-button {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .tab-button.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .controls-wrapper {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .language-selector {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            border: 2px solid var(--border);
        }

        .lang-flag {
            cursor: pointer;
            font-size: 1.2rem;
            filter: grayscale(1);
            opacity: 0.6;
            transition: all 0.2s;
        }

        .lang-flag:hover {
            filter: grayscale(0);
            opacity: 1;
            transform: scale(1.1);
        }

        .lang-flag.active {
            filter: grayscale(0);
            opacity: 1;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .calculator-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 2px solid var(--border);
        }

        .calculator-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--accent);
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1.2rem;
            transition: border-color 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .result-box {
            background: linear-gradient(135deg, var(--accent) 0%, #ff8555 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
        }

        .result-label {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 4rem;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .result-unit {
            font-size: 1.5rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid var(--accent);
            width: 100%;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,107,53,0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background: var(--danger);
            border-color: var(--danger);
        }

        .btn-small {
            width: auto;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .history-section {
            margin-top: 3rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .history-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .history-item {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent);
            transition: all 0.3s;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(255,107,53,0.3);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .history-item-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .history-item-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .history-item-delete:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        .history-item-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 0.8rem;
        }

        .history-data-item {
            color: var(--text-secondary);
        }

        .history-data-item strong {
            color: var(--text-primary);
        }

        .history-result {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .empty-history {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .info-box {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent);
        }

        .info-box h3 {
            color: var(--accent);
            margin-bottom: 0.8rem;
        }

        .info-box p {
            color: var(--text-secondary);
            margin: 0.5rem 0;
        }

        /* Rolki App Specific Styles */
        .rolki-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }

        section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .help-text {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .continuation-group {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid var(--border);
        }

        /* Config Panel Styles */
        .config-panel {
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }

        .config-header:hover {
            background: rgba(255, 107, 53, 0.1);
        }

        .config-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-icon {
            font-size: 1.2rem;
        }

        .config-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .config-header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .config-summary {
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-width: 400px;
            text-align: right;
        }

        .toggle-arrow {
            font-size: 1rem;
            transition: transform 0.3s;
            color: var(--accent);
        }

        .toggle-arrow.rotated {
            transform: rotate(180deg);
        }

        .config-body {
            padding: 1rem;
            border-top: 1px solid var(--border);
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            max-height: 1000px;
            opacity: 1;
        }

        .config-body.collapsed {
            max-height: 0;
            padding: 0 1rem;
            overflow: hidden;
            border-top: none;
            opacity: 0;
        }

        .config-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .config-continuation {
            margin-top: 1rem;
        }

        .continuation-fields {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border);
        }

        .continuation-fields.visible {
            display: block;
        }

        .continuation-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .inherited-rolls {
            background: rgba(158, 158, 158, 0.15);
            border: 2px dashed #9e9e9e;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            opacity: 0.85;
        }

        .inherited-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .inherited-info {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-card {
            background: var(--bg-tertiary);
            padding: 1.25rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--accent);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }

        /* Order Progress Bar */
        .order-progress-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .progress-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .progress-icon {
            font-size: 1.3rem;
        }

        .progress-stats {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .progress-stats strong,
        .progress-stats span:first-child {
            color: var(--text-primary);
            font-weight: 700;
        }

        .progress-percentage {
            margin-left: 0.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .progress-bar-container {
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border);
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            border-radius: 10px;
            transition: width 0.5s ease, background 0.5s ease;
            position: relative;
        }

        .progress-bar.warning-70 {
            background: linear-gradient(90deg, #ffc107, #ffca28);
        }

        .progress-bar.warning-80 {
            background: linear-gradient(90deg, #ff9800, #ffb74d);
        }

        .progress-bar.warning-90 {
            background: linear-gradient(90deg, #f44336, #ef5350);
        }

        .progress-bar.complete {
            background: linear-gradient(90deg, #9c27b0, #ba68c8);
        }

        .progress-remaining {
            margin-top: 0.75rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-align: right;
        }

        .progress-remaining strong {
            color: var(--accent);
        }

        /* Sugestia wagi - subtelne wyr√≥≈ºnienie */
        .form-group input.has-suggestion::placeholder {
            color: #4ecdc4;
            opacity: 0.85;
            font-style: italic;
            font-weight: 600;
        }

        .form-group input.has-suggestion {
            border-color: rgba(78, 205, 196, 0.5);
        }

        .rolls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .rolls-list {
            max-height: 1600px;
            overflow-y: auto;
        }

        .empty-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
            font-style: italic;
        }

        .roll-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent);
            transition: all 0.2s;
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease-out;
        }

        .roll-item:hover {
            background: #3a3a3a;
            transform: translateX(4px);
            box-shadow: 0 2px 4px rgba(255, 107, 53, 0.2);
        }

        .roll-info {
            flex: 1;
        }

        .roll-number {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .roll-number-dual {
            margin-bottom: 0.5rem;
        }

        .roll-number-dual .order-number,
        .roll-number-dual .shift-number {
            display: block;
            font-size: 0.95rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .roll-number-dual .order-number {
            color: var(--accent);
        }

        .roll-number-dual .shift-number {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .roll-details {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.25rem;
        }

        .roll-detail {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .roll-detail strong {
            color: var(--accent);
        }

        .roll-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .roll-actions {
            margin-left: 1rem;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .pallet-container {
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 3px solid var(--accent);
            box-shadow: 0 6px 12px rgba(255, 107, 53, 0.3);
            position: relative;
        }

        .pallet-container:nth-child(even) {
            border-color: #4ecdc4;
            box-shadow: 0 6px 12px rgba(78, 205, 196, 0.3);
        }

        .pallet-container:nth-child(3n) {
            border-color: #ffe66d;
            box-shadow: 0 6px 12px rgba(255, 230, 109, 0.3);
        }

        .pallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .pallet-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pallet-container:nth-child(even) .pallet-title {
            color: #4ecdc4;
        }

        .pallet-container:nth-child(3n) .pallet-title {
            color: #ffe66d;
        }

        .pallet-icon {
            font-size: 1.5rem;
        }

        .pallet-summary {
            display: flex;
            gap: 1.5rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .pallet-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pallet-stat strong {
            color: var(--text-primary);
        }

        .pallet-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit-pallet {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-edit-pallet:hover {
            background: #45b8b0;
            transform: scale(1.05);
        }

        .pallet-rolls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            max-height: 5000px;
            opacity: 1;
        }

        .pallet-rolls.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
            gap: 0;
        }

        .pallet-container .roll-item {
            margin-bottom: 0;
            border-left-width: 3px;
        }

        .pallet-toggle-arrow {
            font-size: 1.2rem;
            transition: transform 0.3s;
            cursor: pointer;
            color: var(--accent);
            user-select: none;
        }

        .pallet-toggle-arrow.collapsed {
            transform: rotate(-90deg);
        }

        .pallet-header {
            cursor: pointer;
            user-select: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
        }

        .modal-footer .btn {
            flex: 1;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .rolls-list::-webkit-scrollbar {
            width: 8px;
        }

        .rolls-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .rolls-list::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }

        .rolls-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }

            .result-value {
                font-size: 3rem;
            }

            .history-item-data {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .tab-switcher {
                width: 100%;
                justify-content: center;
            }

            .tab-button {
                flex: 1;
                padding: 0.75rem 0.5rem;
                font-size: 0.9rem;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .summary-value {
                font-size: 1.75rem;
            }

            .roll-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .roll-actions {
                margin-left: 0;
                margin-top: 0.5rem;
                width: 100%;
            }

            .btn-delete {
                width: 100%;
            }

            /* Rolki form responsive */
            #rolkiTab .form-group input {
                font-size: 1.1rem !important;
                padding: 1rem !important;
            }

            #rolkiTab section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="header">
            <div class="header-content">
                <div class="title">SENTREX - Kalkulatory Produkcji</div>

                <!-- Tab Switcher -->
                <div class="tab-switcher">
                    <button class="tab-button active" onclick="switchTab('obrazki')">
                        üìä Kalkulator Obrazk√≥w
                    </button>
                    <button class="tab-button" onclick="switchTab('rolki')">
                        üì¶ Licznik Rolek
                    </button>
                </div>

                <div class="controls-wrapper">
                    <div class="language-selector" id="languageSelectorObrazki">
                        <span onclick="ObrazkiApp.setLanguage('pl')" class="lang-flag" data-lang="pl" title="Polski">üáµüá±</span>
                        <span onclick="ObrazkiApp.setLanguage('ua')" class="lang-flag" data-lang="ua" title="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞">üá∫üá¶</span>
                        <span onclick="ObrazkiApp.setLanguage('ru')" class="lang-flag" data-lang="ru" title="–†—É—Å—Å–∫–∏–π">üá∑üá∫</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleHelpObrazki()" data-translate-title-key="help_button_title" style="font-size: 1rem; padding: 0.5rem 1rem;" id="helpButtonObrazki">
                        <span data-translate-key="help_button">‚ùì Jak to dzia≈Ça?</span>
                    </button>
                    <button class="theme-toggle" onclick="toggleTheme()" data-translate-title-key="theme_toggle_title" title="Zmie≈Ñ motyw">üåì</button>
                </div>
            </div>
        </div>

        <!-- OBRAZKI TAB CONTENT -->
        <div id="obrazkiTab" class="tab-content active">
            <!-- ROZSUWANE INFO -->
            <div id="helpBoxObrazki" class="info-box" style="max-width: 1200px; margin: 1rem auto; padding: 0 1rem; display: none;">
                <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--accent);">
                    <h3 style="color: var(--accent); margin-bottom: 0.8rem;" data-translate-key="help_box_title">‚ÑπÔ∏è Jak to dzia≈Ça?</h3>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;" data-translate-key="help_meters"><strong>Metry:</strong> D≈Çugo≈õƒá zadrukowanej rolki papieru (np. 6289m)</p>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;" data-translate-key="help_sleeve"><strong>Wa≈Çek (Sleeve):</strong> ≈õrednica sleeve'a w centymetrach (np. 59cm)</p>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;" data-translate-key="help_motifs"><strong>Ilo≈õƒá motyw√≥w:</strong> Ile obrazk√≥w mie≈õci siƒô na jednym sleeve (np. 2)</p>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;" data-translate-key="help_formula"><strong>Wz√≥r:</strong> ((Metry / Wa≈Çek) √ó 100) √ó Ilo≈õƒá motyw√≥w = Liczba obrazk√≥w</p>
                </div>
            </div>

            <div class="container">
                <div class="calculator-card">
                    <div class="calculator-header" data-translate-key="card_header">Oblicz liczbƒô obrazk√≥w</div>

                    <form id="calculatorFormObrazki" onsubmit="ObrazkiApp.calculate(event)">
                        <!-- Panel konfiguracji - Obrazki -->
                        <div class="config-panel" id="configPanelObrazki">
                            <div class="config-header" onclick="toggleConfigPanelObrazki()">
                                <div class="config-header-left">
                                    <span class="config-icon">‚öôÔ∏è</span>
                                    <span class="config-title" data-translate-key="config_header_short">KONFIGURACJA</span>
                                </div>
                                <div class="config-header-right">
                                    <span class="config-summary" id="configSummaryObrazki"></span>
                                    <span class="toggle-arrow" id="configArrowObrazki">‚ñº</span>
                                </div>
                            </div>

                            <div class="config-body" id="configBodyObrazki">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="walekObrazki" style="font-size: 0.9rem;" data-translate-key="sleeve_label">üîß Wa≈Çek (cm)</label>
                                        <input
                                            type="number"
                                            id="walekObrazki"
                                            name="walek"
                                            step="0.1"
                                            required
                                            data-translate-placeholder-key="sleeve_placeholder"
                                            placeholder="59.0"
                                            style="font-size: 1rem; padding: 0.7rem;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="motywyObrazki" style="font-size: 0.9rem;" data-translate-key="motifs_label">üé® Motywy</label>
                                        <input
                                            type="number"
                                            id="motywyObrazki"
                                            name="motywy"
                                            step="1"
                                            required
                                            data-translate-placeholder-key="motifs_placeholder"
                                            placeholder="2"
                                            min="1"
                                            style="font-size: 1rem; padding: 0.7rem;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="rolkiObrazki" style="font-size: 0.9rem;" data-translate-key="rolls_label">üî™ Rolek</label>
                                        <input
                                            type="number"
                                            id="rolkiObrazki"
                                            name="rolki"
                                            step="1"
                                            min="1"
                                            value="1"
                                            data-translate-placeholder-key="rolls_placeholder"
                                            placeholder="1"
                                            style="font-size: 1rem; padding: 0.7rem;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DU≈ªE POLE - METRY -->
                        <div class="form-group">
                            <label for="metryObrazki" data-translate-key="meters_label">üìè Metry (m)</label>
                            <input
                                type="number"
                                id="metryObrazki"
                                name="metry"
                                step="0.01"
                                required
                                data-translate-placeholder-key="meters_placeholder"
                                placeholder="6289"
                                autofocus
                                style="font-size: 2.5rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(0, 191, 255, 0.15), rgba(0, 191, 255, 0.05)); border: 3px solid rgba(0, 191, 255, 0.3); font-weight: 700;">
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer; user-select: none;">
                                <input
                                    type="checkbox"
                                    id="zaokraglajObrazki"
                                    name="zaokraglaj"
                                    style="width: 24px; height: 24px; cursor: pointer; accent-color: var(--accent);">
                                <span style="font-size: 1rem;" data-translate-key="rounding_label">üìà ZaokrƒÖglaj w g√≥rƒô (min. +100, max. +200)</span>
                            </label>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem; margin-left: 2rem;" data-translate-key="rounding_desc">
                                ZaokrƒÖgla do pe≈Çnej setki dodajƒÖc minimum 100, maksimum 200 obrazk√≥w
                            </p>
                        </div>

                        <div id="resultBoxObrazki" class="result-box" style="display: none; background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);">
                            <div class="result-label" data-translate-key="result_label_single">Wynik - 1 rolka</div>
                            <div class="result-value" id="resultValueObrazki">0</div>
                            <div class="result-unit" data-translate-key="result_unit">Obrazk√≥w</div>
                            <div id="resultDetailsObrazki" style="font-size: 1rem; opacity: 0.9; margin-top: 0.8rem;"></div>

                            <!-- MA≈ÅA INFO O ROLKACH -->
                            <div id="resultTotalObrazki" style="margin-top: 1rem; font-size: 0.95rem; opacity: 0.85; display: none;">
                                <span id="resultTotalTextObrazki"></span>
                            </div>

                            <!-- PRZYCISK KOPIUJ -->
                            <button type="button" class="btn" onclick="ObrazkiApp.copyResult(event)" style="margin-top: 1.5rem; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4);">
                                <span data-translate-key="copy_button">üìã Skopiuj wynik (format systemu)</span>
                            </button>
                        </div>

                        <button type="submit" class="btn"><span data-translate-key="calculate_button">üî¢ Oblicz</span></button>
                    </form>
                </div>

                <div class="history-section">
                    <!-- STATYSTYKI -->
                    <div class="calculator-card" style="margin-bottom: 2rem; padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.3rem;" data-translate-key="stats_today">üìä Ilo≈õƒá oblicze≈Ñ</div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="statTodayObrazki">0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.3rem;" data-translate-key="stats_total_images">üéØ ≈ÅƒÖcznie obrazk√≥w</div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="statTotalObrazki">0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.3rem;" data-translate-key="stats_avg_roll">üìè ≈örednia rolka</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #00bfff;" id="statAvgObrazki">0 m</div>
                            </div>
                        </div>
                    </div>

                    <div class="history-header">
                        <div class="history-title" data-translate-key="history_title">üìú Historia oblicze≈Ñ</div>
                        <button class="btn btn-danger" onclick="ObrazkiApp.clearHistory()" style="width: auto; padding: 0.6rem 1.2rem;">
                            <span data-translate-key="clear_history_button">üóëÔ∏è Wyczy≈õƒá historiƒô</span>
                        </button>
                    </div>

                    <div id="historyContainerObrazki">
                        <div class="empty-history" data-translate-key="empty_history">
                            Brak historii oblicze≈Ñ. Wykonaj pierwsze obliczenie!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROLKI TAB CONTENT -->
        <div id="rolkiTab" class="tab-content">
            <div class="container rolki-container">
                <!-- Progress Bar Zlecenia -->
                <section class="order-progress-section" id="orderProgressSection" style="display: none;">
                    <div class="progress-header">
                        <div class="progress-title">
                            <span class="progress-icon">üìä</span>
                            <span>Postƒôp zlecenia</span>
                        </div>
                        <div class="progress-stats">
                            <span id="progressCurrent">0</span> / <span id="progressTotal">0</span>
                            <span id="progressUnit">obrazk√≥w</span>
                            <span class="progress-percentage" id="progressPercentage">(0%)</span>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                    </div>
                    <div class="progress-remaining" id="progressRemaining">
                        Pozosta≈Ço: <strong>0</strong> <span id="progressRemainingUnit">obrazk√≥w</span>
                    </div>
                </section>

                <!-- Formularz dodawania rolek -->
                <section class="add-section">
                    <h2>Dodaj rolki</h2>
                    <form id="addRollFormRolki">
                        <!-- G≈Ç√≥wne pola w 2 kolumnach -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="weightRolki" style="font-size: 1.1rem;">üì¶ Waga rolki (kg) *</label>
                                <input
                                    type="number"
                                    id="weightRolki"
                                    step="0.01"
                                    required
                                    placeholder="np. 125.5"
                                    autofocus
                                    style="font-size: 1.3rem; padding: 1.2rem; font-weight: 700;">
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="imagesRolki" style="font-size: 1.1rem;">üñºÔ∏è Liczba obrazk√≥w (opcjonalnie)</label>
                                <input
                                    type="number"
                                    id="imagesRolki"
                                    step="1"
                                    placeholder="np. 1000"
                                    style="font-size: 1.3rem; padding: 1.2rem; font-weight: 700;">
                            </div>
                        </div>

                        <!-- Panel konfiguracji -->
                        <div class="config-panel">
                            <div class="config-header" onclick="toggleConfigPanel()">
                                <div class="config-header-left">
                                    <span class="config-icon">‚öôÔ∏è</span>
                                    <span class="config-title">KONFIGURACJA</span>
                                </div>
                                <div class="config-header-right">
                                    <span class="config-summary" id="configSummary"></span>
                                    <span class="toggle-arrow" id="configArrow">‚ñº</span>
                                </div>
                            </div>

                            <div class="config-body" id="configBody">
                                <!-- RzƒÖd 1: Ilo≈õƒá rolek + Rolek na paletƒô -->
                                <div class="config-row">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="quantityRolki" style="font-size: 0.95rem;">üî¢ Ilo≈õƒá rolek</label>
                                        <input
                                            type="number"
                                            id="quantityRolki"
                                            value="1"
                                            min="1"
                                            required
                                            style="font-size: 1.1rem; padding: 0.8rem;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="rollsPerPalletRolki" style="font-size: 0.95rem;">üì¶ Rolek na paletƒô</label>
                                        <input
                                            type="number"
                                            id="rollsPerPalletRolki"
                                            value="3"
                                            min="1"
                                            required
                                            style="font-size: 1.1rem; padding: 0.8rem;">
                                    </div>
                                </div>

                                <!-- RzƒÖd 2: Kontynuacja -->
                                <div class="config-continuation">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="continuationModeRolki">
                                        <span>Kontynuacja zlecenia po poprzedniej zmianie</span>
                                    </label>

                                    <!-- Pola kontynuacji (widoczne gdy checkbox zaznaczony) -->
                                    <div class="continuation-fields" id="continuationFields">
                                        <div class="continuation-row">
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label for="lastRollNumberRolki" style="font-size: 0.9rem;">Ostatnia rolka ze zlecenia</label>
                                                <input
                                                    type="number"
                                                    id="lastRollNumberRolki"
                                                    min="0"
                                                    value="0"
                                                    placeholder="np. 20"
                                                    style="font-size: 1rem; padding: 0.7rem;">
                                                <small class="help-text">Twoje rolki zacznƒÖ siƒô od tego numeru + 1</small>
                                            </div>

                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label for="startingPalletNumberRolki" style="font-size: 0.9rem;">Numer palety do kontynuacji</label>
                                                <input
                                                    type="number"
                                                    id="startingPalletNumberRolki"
                                                    min="1"
                                                    value="1"
                                                    placeholder="np. 8"
                                                    style="font-size: 1rem; padding: 0.7rem;">
                                                <small class="help-text">Od kt√≥rej palety zaczynasz (np. #8)</small>
                                            </div>

                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label for="inheritedRollsCountRolki" style="font-size: 0.9rem;">Rolek ju≈º na palecie</label>
                                                <input
                                                    type="number"
                                                    id="inheritedRollsCountRolki"
                                                    min="0"
                                                    value="0"
                                                    placeholder="np. 2"
                                                    style="font-size: 1rem; padding: 0.7rem;">
                                                <small class="help-text">Ile rolek jest ju≈º na palecie</small>
                                            </div>

                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label for="inheritedRollsWeightRolki" style="font-size: 0.9rem;">Ich ≈ÇƒÖczna waga (kg)</label>
                                                <input
                                                    type="number"
                                                    id="inheritedRollsWeightRolki"
                                                    min="0"
                                                    step="0.01"
                                                    value="0"
                                                    placeholder="np. 45.5"
                                                    style="font-size: 1rem; padding: 0.7rem;">
                                                <small class="help-text">Suma wagi rolek z poprzedniej zmiany</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RzƒÖd 3: D≈Çugo≈õƒá zlecenia -->
                                <div class="config-row" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border);">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="orderLengthRolki" style="font-size: 0.95rem;">üìã D≈Çugo≈õƒá zlecenia</label>
                                        <input
                                            type="number"
                                            id="orderLengthRolki"
                                            min="0"
                                            step="1"
                                            placeholder="np. 2000000"
                                            style="font-size: 1.1rem; padding: 0.8rem;">
                                        <small class="help-text">Zostaw puste je≈õli nie chcesz ≈õledziƒá postƒôpu</small>
                                    </div>

                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="orderUnitRolki" style="font-size: 0.95rem;">üìè Jednostka</label>
                                        <select id="orderUnitRolki" style="font-size: 1.1rem; padding: 0.8rem;">
                                            <option value="images">Obrazki</option>
                                            <option value="kg">Kilogramy (kg)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Pola kontynuacji zlecenia (widoczne tylko przy w≈ÇƒÖczonej kontynuacji I d≈Çugo≈õci zlecenia) -->
                                <div class="continuation-order-fields" id="continuationOrderFields" style="display: none; margin-top: 1rem;">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label for="orderCompletedRolki" style="font-size: 0.95rem;">‚úÖ Ju≈º wykonano</label>
                                        <input
                                            type="number"
                                            id="orderCompletedRolki"
                                            min="0"
                                            step="1"
                                            value="0"
                                            placeholder="np. 950000"
                                            style="font-size: 1.1rem; padding: 0.8rem;">
                                        <small class="help-text">Ile zosta≈Ço zrobione przed TwojƒÖ zmianƒÖ</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Dodaj</button>
                    </form>
                </section>

                <!-- Podsumowanie -->
                <section class="summary-section">
                    <h2>üìä Podsumowanie zmiany</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
                        <div class="summary-card" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(255, 107, 53, 0.05)); border: 3px solid var(--accent);">
                            <div class="summary-label">üì¶ Liczba palet</div>
                            <div class="summary-value" id="totalPalletsRolki" style="font-size: 2.5rem;">0</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.15), rgba(78, 205, 196, 0.05)); border: 3px solid #4ecdc4;">
                            <div class="summary-label">üéØ Liczba rolek</div>
                            <div class="summary-value" id="totalRollsRolki" style="font-size: 2.5rem; color: #4ecdc4;">0</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, rgba(255, 230, 109, 0.15), rgba(255, 230, 109, 0.05)); border: 3px solid #ffe66d;">
                            <div class="summary-label">‚öñÔ∏è Suma wag (kg)</div>
                            <div class="summary-value" id="totalWeightRolki" style="font-size: 2.5rem; color: #ffe66d;">0</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.05)); border: 3px solid var(--success);">
                            <div class="summary-label">üñºÔ∏è Suma obrazk√≥w</div>
                            <div class="summary-value" id="totalImagesRolki" style="font-size: 2.5rem; color: var(--success);">0</div>
                        </div>
                    </div>
                </section>

                <!-- Lista rolek -->
                <section class="rolls-section">
                    <div class="rolls-header">
                        <h2>üìã Lista rolek na paletach</h2>
                        <button id="clearAllBtnRolki" class="btn btn-danger btn-small" style="display: none;">
                            üóëÔ∏è Wyczy≈õƒá wszystko
                        </button>
                    </div>
                    <div id="rollsListRolki" class="rolls-list">
                        <p class="empty-message">Brak rolek. Dodaj pierwszƒÖ rolkƒô powy≈ºej.</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <footer>
        Made by Kamil Matysek | v1.0.4
    </footer>

    <!-- Modal edycji palety -->
    <div id="editPalletModalRolki" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edytuj paletƒô</h3>
                <p class="subtitle" id="modalPalletInfoRolki"></p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editRollsPerPalletRolki">Liczba rolek na tej palecie</label>
                    <input
                        type="number"
                        id="editRollsPerPalletRolki"
                        min="1"
                        value="3">
                    <small class="help-text">Zmie≈Ñ liczbƒô rolek, a pozosta≈Çe zostanƒÖ przesuniƒôte do nastƒôpnej palety</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditBtnRolki">Anuluj</button>
                <button class="btn btn-primary" id="saveEditBtnRolki">Zapisz</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // CONFIG PANEL TOGGLE (FOR ROLKI TAB)
        // =================================================================
        function toggleConfigPanel() {
            const configBody = document.getElementById('configBody');
            const configArrow = document.getElementById('configArrow');
            const isCollapsed = configBody.classList.contains('collapsed');

            if (isCollapsed) {
                configBody.classList.remove('collapsed');
                configArrow.classList.remove('rotated');
                localStorage.setItem('rolki_configCollapsed', 'false');
            } else {
                configBody.classList.add('collapsed');
                configArrow.classList.add('rotated');
                localStorage.setItem('rolki_configCollapsed', 'true');
            }
        }

        function updateConfigSummary() {
            const quantity = document.getElementById('quantityRolki').value;
            const rollsPerPallet = document.getElementById('rollsPerPalletRolki').value;
            const isContinuation = document.getElementById('continuationModeRolki').checked;
            const lastRollNumber = document.getElementById('lastRollNumberRolki').value;
            const startingPalletNumber = document.getElementById('startingPalletNumberRolki') ? document.getElementById('startingPalletNumberRolki').value : '1';
            const inheritedCount = document.getElementById('inheritedRollsCountRolki').value;
            const inheritedWeight = document.getElementById('inheritedRollsWeightRolki').value;
            const orderLength = document.getElementById('orderLengthRolki') ? document.getElementById('orderLengthRolki').value : '';
            const orderUnit = document.getElementById('orderUnitRolki') ? document.getElementById('orderUnitRolki').value : 'images';

            let summaryText = `Ilo≈õƒá: ${quantity} | ${rollsPerPallet} rolki/paletƒô`;

            if (isContinuation) {
                summaryText += ` | Kont. od #${lastRollNumber}, paleta #${startingPalletNumber}`;
                if (parseInt(inheritedCount) > 0) {
                    summaryText += ` (${inheritedCount} na pal.)`;
                }
            }

            if (parseFloat(orderLength) > 0) {
                const unitShort = orderUnit === 'images' ? 'obr.' : 'kg';
                summaryText += ` | Zlec: ${formatOrderLength(orderLength)}${unitShort}`;
            }

            document.getElementById('configSummary').textContent = summaryText;
        }

        function formatOrderLength(num) {
            num = parseFloat(num);
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M ';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'k ';
            }
            return num + ' ';
        }

        function togglePallet(headerElement) {
            const palletContainer = headerElement.parentElement;
            const palletRolls = palletContainer.querySelector('.pallet-rolls');
            const arrow = headerElement.querySelector('.pallet-toggle-arrow');

            if (palletRolls.classList.contains('collapsed')) {
                palletRolls.classList.remove('collapsed');
                arrow.classList.remove('collapsed');
            } else {
                palletRolls.classList.add('collapsed');
                arrow.classList.add('collapsed');
            }
        }

        function toggleConfigPanelObrazki() {
            const configBody = document.getElementById('configBodyObrazki');
            const configArrow = document.getElementById('configArrowObrazki');
            const isCollapsed = configBody.classList.contains('collapsed');

            if (isCollapsed) {
                configBody.classList.remove('collapsed');
                configArrow.classList.remove('rotated');
                localStorage.setItem('obrazki_configCollapsed', 'false');
            } else {
                configBody.classList.add('collapsed');
                configArrow.classList.add('rotated');
                localStorage.setItem('obrazki_configCollapsed', 'true');
            }
        }

        function updateConfigSummaryObrazki() {
            const walek = document.getElementById('walekObrazki').value || '-';
            const motywy = document.getElementById('motywyObrazki').value || '-';
            const rolki = document.getElementById('rolkiObrazki').value || '1';

            document.getElementById('configSummaryObrazki').textContent =
                `Wa≈Çek: ${walek}cm | Motywy: ${motywy} | Rolek: ${rolki}`;
        }

        // =================================================================
        // TAB SWITCHING
        // =================================================================
        let currentTab = 'obrazki';

        function switchTab(tabName) {
            // Hide all tabs
            document.getElementById('obrazkiTab').classList.remove('active');
            document.getElementById('rolkiTab').classList.remove('active');

            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Add active to clicked button
            event.target.classList.add('active');

            currentTab = tabName;

            // Show/hide language selector based on tab
            if (tabName === 'obrazki') {
                document.getElementById('languageSelectorObrazki').style.display = 'flex';
                document.getElementById('helpButtonObrazki').style.display = 'block';
            } else {
                document.getElementById('languageSelectorObrazki').style.display = 'none';
                document.getElementById('helpButtonObrazki').style.display = 'none';
            }

            // Save current tab
            localStorage.setItem('currentTab', tabName);
        }

        // Load last tab on page load
        function loadCurrentTab() {
            const savedTab = localStorage.getItem('currentTab') || 'obrazki';
            if (savedTab === 'rolki') {
                document.querySelector('.tab-button.active').classList.remove('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                document.getElementById('obrazkiTab').classList.remove('active');
                document.getElementById('rolkiTab').classList.add('active');
                currentTab = 'rolki';
                document.getElementById('languageSelectorObrazki').style.display = 'none';
                document.getElementById('helpButtonObrazki').style.display = 'none';
            }
        }

        // =================================================================
        // THEME TOGGLE (SHARED)
        // =================================================================
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        function loadTheme() {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
            }
        }

        // =================================================================
        // OBRAZKI APP
        // =================================================================
        const ObrazkiApp = {
            translations: {
                pl: {
                    page_title: "Kalkulator Obrazk√≥w - SENTREX",
                    app_title: "üìä Kalkulator Obrazk√≥w - SENTREX v1.0.5",
                    help_button: "‚ùì Jak to dzia≈Ça?",
                    help_button_title: "Poka≈º pomoc",
                    theme_toggle_title: "Zmie≈Ñ motyw",
                    help_box_title: "‚ÑπÔ∏è Jak to dzia≈Ça?",
                    help_meters: "<strong>Metry:</strong> D≈Çugo≈õƒá zadrukowanej rolki papieru (np. 6289m)",
                    help_sleeve: "<strong>Wa≈Çek (Sleeve):</strong> ≈õrednica sleeve'a w centymetrach (np. 59cm)",
                    help_motifs: "<strong>Ilo≈õƒá motyw√≥w:</strong> Ile obrazk√≥w mie≈õci siƒô na jednym sleeve (np. 2)",
                    help_formula: "<strong>Wz√≥r:</strong> ((Metry / Wa≈Çek) √ó 100) √ó Ilo≈õƒá motyw√≥w = Liczba obrazk√≥w",
                    card_header: "Oblicz liczbƒô obrazk√≥w",
                    config_header: "‚öôÔ∏è KONFIGURACJA (ustaw raz na zmianƒô)",
                    config_header_short: "KONFIGURACJA",
                    sleeve_label: "üîß Wa≈Çek (cm)",
                    sleeve_placeholder: "59.0",
                    motifs_label: "üé® Motywy",
                    motifs_placeholder: "2",
                    rolls_label: "üî™ Rolek",
                    rolls_placeholder: "1",
                    meters_label: "üìè Metry (m)",
                    meters_placeholder: "6289",
                    rounding_label: "üìà ZaokrƒÖglaj w g√≥rƒô (min. +100, max. +200)",
                    rounding_desc: "ZaokrƒÖgla do pe≈Çnej setki dodajƒÖc minimum 100, maksimum 200 obrazk√≥w",
                    result_label_single: "Wynik - 1 rolka",
                    result_unit: "Obrazk√≥w",
                    copy_button: "üìã Skopiuj wynik (format systemu)",
                    calculate_button: "üî¢ Oblicz",
                    stats_today: "üìä Ilo≈õƒá oblicze≈Ñ",
                    stats_total_images: "üéØ ≈ÅƒÖcznie obrazk√≥w",
                    stats_avg_roll: "üìè ≈örednia rolka",
                    history_title: "üìú Historia oblicze≈Ñ",
                    clear_history_button: "üóëÔ∏è Wyczy≈õƒá historiƒô",
                    empty_history: "Brak historii oblicze≈Ñ. Wykonaj pierwsze obliczenie!",
                    history_delete_button: "üóëÔ∏è Usu≈Ñ",
                    history_meters: "<strong>Metry:</strong>",
                    history_sleeve: "<strong>Wa≈Çek:</strong>",
                    history_motifs: "<strong>Motywy:</strong>",
                    history_rolls: "<strong>Rolek:</strong>",
                    history_result_label: "‚û°Ô∏è Wynik:",
                    history_images_unit_single: "obrazk√≥w (1 rolka)",
                    history_rounded_from: "üìà ZaokrƒÖglono z",
                    history_total_label: "üî™ ≈ÅƒÖcznie:",
                    history_total_images_unit: "obrazk√≥w",
                    history_total_from_rolls: "rolek",
                    confirm_delete_item: "Czy na pewno chcesz usunƒÖƒá to obliczenie z historii?",
                    alert_history_empty: "Historia jest ju≈º pusta!",
                    confirm_clear_history: "Czy na pewno chcesz usunƒÖƒá ca≈ÇƒÖ historiƒô ({count} oblicze≈Ñ)?",
                    copied_text: "‚úÖ Skopiowano:",
                    detailed_result_text: "üìä Dok≈Çadny wynik: {exact} (+{diff} obrazk√≥w)",
                    total_result_text: "üî™ ≈ÅƒÖcznie {rolls} rolek: {total} obrazk√≥w ({single} √ó {rolls})",
                    error_invalid_sleeve: "Warto≈õƒá wa≈Çka musi byƒá wiƒôksza od zera!"
                },
                ua: {
                    page_title: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ó–æ–±—Ä–∞–∂–µ–Ω—å - SENTREX",
                    app_title: "üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ó–æ–±—Ä–∞–∂–µ–Ω—å - SENTREX v1.0.5",
                    help_button: "‚ùì –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?",
                    help_button_title: "–ü–æ–∫–∞–∑–∞—Ç–∏ –¥–æ–ø–æ–º–æ–≥—É",
                    theme_toggle_title: "–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É",
                    help_box_title: "‚ÑπÔ∏è –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?",
                    help_meters: "<strong>–ú–µ—Ç—Ä–∏:</strong> –î–æ–≤–∂–∏–Ω–∞ –¥—Ä—É–∫–æ–≤–∞–Ω–æ–≥–æ —Ä—É–ª–æ–Ω—É –ø–∞–ø–µ—Ä—É (–Ω–∞–ø—Ä. 6289–º)",
                    help_sleeve: "<strong>–í–∞–ª–µ–∫ (Sleeve):</strong> –¥—ñ–∞–º–µ—Ç—Ä –≥—ñ–ª—å–∑–∏ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö (–Ω–∞–ø—Ä. 59—Å–º)",
                    help_motifs: "<strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–æ—Ç–∏–≤—ñ–≤:</strong> –°–∫—ñ–ª—å–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å –≤–º—ñ—â—É—î—Ç—å—Å—è –Ω–∞ –æ–¥–Ω—ñ–π –≥—ñ–ª—å–∑—ñ (–Ω–∞–ø—Ä. 2)",
                    help_formula: "<strong>–§–æ—Ä–º—É–ª–∞:</strong> ((–ú–µ—Ç—Ä–∏ / –í–∞–ª–µ–∫) √ó 100) √ó –ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–æ—Ç–∏–≤—ñ–≤ = –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω—å",
                    card_header: "–û–±—á–∏—Å–ª–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω—å",
                    config_header: "‚öôÔ∏è –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø (–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ä–∞–∑ –Ω–∞ –∑–º—ñ–Ω—É)",
                    config_header_short: "–ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø",
                    sleeve_label: "üîß –í–∞–ª–µ–∫ (—Å–º)",
                    sleeve_placeholder: "59.0",
                    motifs_label: "üé® –ú–æ—Ç–∏–≤–∏",
                    motifs_placeholder: "2",
                    rolls_label: "üî™ –†—É–ª–æ–Ω—ñ–≤",
                    rolls_placeholder: "1",
                    meters_label: "üìè –ú–µ—Ç—Ä–∏ (–º)",
                    meters_placeholder: "6289",
                    rounding_label: "üìà –û–∫—Ä—É–≥–ª—é–≤–∞—Ç–∏ –≤–≥–æ—Ä—É (–º—ñ–Ω. +100, –º–∞–∫—Å. +200)",
                    rounding_desc: "–û–∫—Ä—É–≥–ª—é—î –¥–æ –ø–æ–≤–Ω–æ—ó —Å–æ—Ç–Ω—ñ, –¥–æ–¥–∞—é—á–∏ –º—ñ–Ω—ñ–º—É–º 100, –º–∞–∫—Å–∏–º—É–º 200 –∑–æ–±—Ä–∞–∂–µ–Ω—å",
                    result_label_single: "–†–µ–∑—É–ª—å—Ç–∞—Ç - 1 —Ä—É–ª–æ–Ω",
                    result_unit: "–ó–æ–±—Ä–∞–∂–µ–Ω—å",
                    copy_button: "üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ñ–æ—Ä–º–∞—Ç —Å–∏—Å—Ç–µ–º–∏)",
                    calculate_button: "üî¢ –û–±—á–∏—Å–ª–∏—Ç–∏",
                    stats_today: "üìä –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–±—á–∏—Å–ª–µ–Ω—å",
                    stats_total_images: "üéØ –í—Å—å–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω—å",
                    stats_avg_roll: "üìè –°–µ—Ä–µ–¥–Ω—ñ–π —Ä—É–ª–æ–Ω",
                    history_title: "üìú –Ü—Å—Ç–æ—Ä—ñ—è –æ–±—á–∏—Å–ª–µ–Ω—å",
                    clear_history_button: "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é",
                    empty_history: "–Ü—Å—Ç–æ—Ä—ñ—è –æ–±—á–∏—Å–ª–µ–Ω—å –ø–æ—Ä–æ–∂–Ω—è. –ó—Ä–æ–±—ñ—Ç—å –ø–µ—Ä—à–µ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è!",
                    history_delete_button: "üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏",
                    history_meters: "<strong>–ú–µ—Ç—Ä–∏:</strong>",
                    history_sleeve: "<strong>–í–∞–ª–µ–∫:</strong>",
                    history_motifs: "<strong>–ú–æ—Ç–∏–≤–∏:</strong>",
                    history_rolls: "<strong>–†—É–ª–æ–Ω—ñ–≤:</strong>",
                    history_result_label: "‚û°Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç:",
                    history_images_unit_single: "–∑–æ–±—Ä–∞–∂–µ–Ω—å (1 —Ä—É–ª–æ–Ω)",
                    history_rounded_from: "üìà –û–∫—Ä—É–≥–ª–µ–Ω–æ –∑",
                    history_total_label: "üî™ –í—Å—å–æ–≥–æ:",
                    history_total_images_unit: "–∑–æ–±—Ä–∞–∂–µ–Ω—å",
                    history_total_from_rolls: "—Ä—É–ª–æ–Ω—ñ–≤",
                    confirm_delete_item: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –∑ —ñ—Å—Ç–æ—Ä—ñ—ó?",
                    alert_history_empty: "–Ü—Å—Ç–æ—Ä—ñ—è –≤–∂–µ –ø–æ—Ä–æ–∂–Ω—è!",
                    confirm_clear_history: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é ({count} –æ–±—á–∏—Å–ª–µ–Ω—å)?",
                    copied_text: "‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ:",
                    detailed_result_text: "üìä –¢–æ—á–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {exact} (+{diff} –∑–æ–±—Ä–∞–∂–µ–Ω—å)",
                    total_result_text: "üî™ –í—Å—å–æ–≥–æ {rolls} —Ä—É–ª–æ–Ω—ñ–≤: {total} –∑–æ–±—Ä–∞–∂–µ–Ω—å ({single} √ó {rolls})",
                    error_invalid_sleeve: "–ó–Ω–∞—á–µ–Ω–Ω—è –≤–∞–ª—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ –Ω—É–ª—è!"
                },
                ru: {
                    page_title: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - SENTREX",
                    app_title: "üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - SENTREX v1.0.5",
                    help_button: "‚ùì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
                    help_button_title: "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å",
                    theme_toggle_title: "–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É",
                    help_box_title: "‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
                    help_meters: "<strong>–ú–µ—Ç—Ä—ã:</strong> –î–ª–∏–Ω–∞ –ø–µ—á–∞—Ç–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞ –±—É–º–∞–≥–∏ (–Ω–∞–ø—Ä. 6289–º)",
                    help_sleeve: "<strong>–í–∞–ª (Sleeve):</strong> –¥–∏–∞–º–µ—Ç—Ä –≥–∏–ª—å–∑—ã –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö (–Ω–∞–ø—Ä. 59—Å–º)",
                    help_motifs: "<strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ—Ç–∏–≤–æ–≤:</strong> –°–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–π –≥–∏–ª—å–∑–µ (–Ω–∞–ø—Ä. 2)",
                    help_formula: "<strong>–§–æ—Ä–º—É–ª–∞:</strong> ((–ú–µ—Ç—Ä—ã / –í–∞–ª) √ó 100) √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ—Ç–∏–≤–æ–≤ = –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
                    card_header: "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
                    config_header: "‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑ –Ω–∞ —Å–º–µ–Ω—É)",
                    config_header_short: "–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø",
                    sleeve_label: "üîß –í–∞–ª (—Å–º)",
                    sleeve_placeholder: "59.0",
                    motifs_label: "üé® –ú–æ—Ç–∏–≤—ã",
                    motifs_placeholder: "2",
                    rolls_label: "üî™ –†—É–ª–æ–Ω–æ–≤",
                    rolls_placeholder: "1",
                    meters_label: "üìè –ú–µ—Ç—Ä—ã (–º)",
                    meters_placeholder: "6289",
                    rounding_label: "üìà –û–∫—Ä—É–≥–ª—è—Ç—å –≤–≤–µ—Ä—Ö (–º–∏–Ω. +100, –º–∞–∫—Å. +200)",
                    rounding_desc: "–û–∫—Ä—É–≥–ª—è–µ—Ç –¥–æ –ø–æ–ª–Ω–æ–π —Å–æ—Ç–Ω–∏, –¥–æ–±–∞–≤–ª—è—è –º–∏–Ω–∏–º—É–º 100, –º–∞–∫—Å–∏–º—É–º 200 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
                    result_label_single: "–†–µ–∑—É–ª—å—Ç–∞—Ç - 1 —Ä—É–ª–æ–Ω",
                    result_unit: "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
                    copy_button: "üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ñ–æ—Ä–º–∞—Ç —Å–∏—Å—Ç–µ–º—ã)",
                    calculate_button: "üî¢ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å",
                    stats_today: "üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—á—ë—Ç–æ–≤",
                    stats_total_images: "üéØ –í—Å–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
                    stats_avg_roll: "üìè –°—Ä–µ–¥–Ω–∏–π —Ä—É–ª–æ–Ω",
                    history_title: "üìú –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤",
                    clear_history_button: "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é",
                    empty_history: "–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤ –ø—É—Å—Ç–∞. –°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–∞—Å—á—ë—Ç!",
                    history_delete_button: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å",
                    history_meters: "<strong>–ú–µ—Ç—Ä—ã:</strong>",
                    history_sleeve: "<strong>–í–∞–ª:</strong>",
                    history_motifs: "<strong>–ú–æ—Ç–∏–≤—ã:</strong>",
                    history_rolls: "<strong>–†—É–ª–æ–Ω–æ–≤:</strong>",
                    history_result_label: "‚û°Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç:",
                    history_images_unit_single: "–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (1 —Ä—É–ª–æ–Ω)",
                    history_rounded_from: "üìà –û–∫—Ä—É–≥–ª–µ–Ω–æ —Å",
                    history_total_label: "üî™ –í—Å–µ–≥–æ:",
                    history_total_images_unit: "–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
                    history_total_from_rolls: "—Ä—É–ª–æ–Ω–æ–≤",
                    confirm_delete_item: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—á—ë—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?",
                    alert_history_empty: "–ò—Å—Ç–æ—Ä–∏—è —É–∂–µ –ø—É—Å—Ç–∞!",
                    confirm_clear_history: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é ({count} —Ä–∞—Å—á—ë—Ç–æ–≤)?",
                    copied_text: "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ:",
                    detailed_result_text: "üìä –¢–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {exact} (+{diff} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)",
                    total_result_text: "üî™ –í—Å–µ–≥–æ {rolls} —Ä—É–ª–æ–Ω–æ–≤: {total} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ({single} √ó {rolls})",
                    error_invalid_sleeve: "–ó–Ω–∞—á–µ–Ω–∏–µ –≤–∞–ª–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è!"
                }
            },

            currentLang: 'pl',
            history: [],
            lastResult: 0,

            setLanguage(lang) {
                if (!this.translations[lang]) return;
                this.currentLang = lang;
                localStorage.setItem('obrazki_language', lang);

                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (this.translations[lang][key]) {
                        el.innerHTML = this.translations[lang][key];
                    }
                });

                document.querySelectorAll('[data-translate-title-key]').forEach(el => {
                    const key = el.dataset.translateTitleKey;
                    if (this.translations[lang][key]) {
                        el.title = this.translations[lang][key];
                    }
                });

                document.querySelectorAll('[data-translate-placeholder-key]').forEach(el => {
                    const key = el.dataset.translatePlaceholderKey;
                    if (this.translations[lang][key]) {
                        el.placeholder = this.translations[lang][key];
                    }
                });

                document.querySelectorAll('.lang-flag').forEach(flag => {
                    flag.classList.toggle('active', flag.dataset.lang === lang);
                });

                this.renderHistory();

                const resultBox = document.getElementById('resultBoxObrazki');
                if (resultBox.style.display === 'block' && this.history.length > 0) {
                    const lastCalc = this.history[0];
                    const resultDetails = document.getElementById('resultDetailsObrazki');
                    const resultTotal = document.getElementById('resultTotalObrazki');
                    const resultTotalText = document.getElementById('resultTotalTextObrazki');

                    if (lastCalc.zaokraglono) {
                        const roznica = lastCalc.wynikKo≈Ñcowy - lastCalc.wynikDok≈Çadny;
                        resultDetails.innerHTML = this.translations[this.currentLang].detailed_result_text
                            .replace('{exact}', lastCalc.wynikDok≈Çadny.toLocaleString('pl-PL'))
                            .replace('{diff}', roznica);
                    } else {
                        resultDetails.innerHTML = '';
                    }

                    if (lastCalc.rolki > 1) {
                        resultTotal.style.display = 'block';
                        resultTotalText.textContent = this.translations[this.currentLang].total_result_text
                            .replace(/{rolls}/g, lastCalc.rolki)
                            .replace('{total}', lastCalc.wynikLacznie.toLocaleString('pl-PL'))
                            .replace('{single}', lastCalc.wynikKo≈Ñcowy.toLocaleString('pl-PL'));
                    } else {
                        resultTotal.style.display = 'none';
                    }
                }
            },

            loadLanguage() {
                const savedLang = localStorage.getItem('obrazki_language');
                if (savedLang && this.translations[savedLang]) {
                    this.setLanguage(savedLang);
                } else {
                    this.setLanguage('pl');
                }
            },

            loadHistory() {
                const saved = localStorage.getItem('obrazki_history');
                if (saved) {
                    try {
                        this.history = JSON.parse(saved);
                        this.renderHistory();
                    } catch (e) {
                        console.error('B≈ÇƒÖd wczytywania historii:', e);
                        this.history = [];
                    }
                }
            },

            saveHistory() {
                localStorage.setItem('obrazki_history', JSON.stringify(this.history));
            },

            saveConfig() {
                const config = {
                    walek: document.getElementById('walekObrazki').value,
                    motywy: document.getElementById('motywyObrazki').value,
                    rolki: document.getElementById('rolkiObrazki').value,
                    zaokraglaj: document.getElementById('zaokraglajObrazki').checked
                };
                localStorage.setItem('obrazki_config', JSON.stringify(config));
            },

            loadConfig() {
                try {
                    const config = JSON.parse(localStorage.getItem('obrazki_config'));
                    if (config) {
                        if (config.walek) document.getElementById('walekObrazki').value = config.walek;
                        if (config.motywy) document.getElementById('motywyObrazki').value = config.motywy;
                        if (config.rolki) document.getElementById('rolkiObrazki').value = config.rolki;
                        if (config.zaokraglaj !== undefined) document.getElementById('zaokraglajObrazki').checked = config.zaokraglaj;
                    }
                } catch (e) {
                    console.error('B≈ÇƒÖd wczytywania konfiguracji:', e);
                }
            },

            calculate(event) {
                event.preventDefault();

                const metry = parseFloat(document.getElementById('metryObrazki').value);
                const walek = parseFloat(document.getElementById('walekObrazki').value);
                const motywy = parseInt(document.getElementById('motywyObrazki').value);
                const zaokraglaj = document.getElementById('zaokraglajObrazki').checked;
                const rolki = parseInt(document.getElementById('rolkiObrazki').value) || 1;

                // Zapisz konfiguracjƒô po obliczeniu
                this.saveConfig();

                if (walek <= 0) {
                    alert(this.translations[this.currentLang].error_invalid_sleeve);
                    return;
                }

                const wynikDok≈Çadny = Math.floor(((metry / walek) * 100) * motywy);
                let wynikKo≈Ñcowy = wynikDok≈Çadny;
                let zaokraglono = false;

                if (zaokraglaj) {
                    const doDodania = 100 + (100 - (wynikDok≈Çadny % 100)) % 100;
                    wynikKo≈Ñcowy = wynikDok≈Çadny + doDodania;
                    zaokraglono = true;
                }

                this.lastResult = wynikKo≈Ñcowy;
                const wynikLacznie = wynikKo≈Ñcowy * rolki;

                const resultBox = document.getElementById('resultBoxObrazki');
                const resultValue = document.getElementById('resultValueObrazki');
                const resultDetails = document.getElementById('resultDetailsObrazki');
                const resultTotal = document.getElementById('resultTotalObrazki');

                resultBox.style.display = 'block';
                resultValue.textContent = wynikKo≈Ñcowy.toLocaleString('pl-PL');

                if (zaokraglono) {
                    const roznica = wynikKo≈Ñcowy - wynikDok≈Çadny;
                    resultDetails.innerHTML = this.translations[this.currentLang].detailed_result_text
                        .replace('{exact}', wynikDok≈Çadny.toLocaleString('pl-PL'))
                        .replace('{diff}', roznica);
                } else {
                    resultDetails.innerHTML = '';
                }

                if (rolki > 1) {
                    resultTotal.style.display = 'block';
                    document.getElementById('resultTotalTextObrazki').textContent = this.translations[this.currentLang].total_result_text
                        .replace(/{rolls}/g, rolki)
                        .replace('{total}', wynikLacznie.toLocaleString('pl-PL'))
                        .replace('{single}', wynikKo≈Ñcowy.toLocaleString('pl-PL'));
                } else {
                    resultTotal.style.display = 'none';
                }

                resultValue.style.transform = 'scale(0)';
                setTimeout(() => {
                    resultValue.style.transition = 'transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                    resultValue.style.transform = 'scale(1)';
                }, 10);

                const historyItem = {
                    id: Date.now(),
                    metry, walek, motywy, rolki, wynikDok≈Çadny, wynikKo≈Ñcowy, wynikLacznie, zaokraglono,
                    timestamp: new Date().toLocaleString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })
                };

                this.history.unshift(historyItem);
                if (this.history.length > 50) this.history = this.history.slice(0, 50);

                this.saveHistory();
                this.renderHistory();
                this.updateStats();
            },

            copyResult(event) {
                const formatted = (this.lastResult / 1000).toFixed(1);

                // Copy to clipboard
                navigator.clipboard.writeText(formatted).then(() => {
                    const btn = event.target.closest('.btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `${this.translations[this.currentLang].copied_text} ${formatted}`;
                    btn.style.background = 'rgba(76, 175, 80, 0.3)';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = 'rgba(255,255,255,0.2)';
                    }, 2000);

                    // AUTO-INSERT INTO ROLKI APP AND SWITCH TAB
                    // Convert format: if result is 25.5, insert 25500 (multiply by 1000)
                    const valueForRolki = this.lastResult;
                    document.getElementById('imagesRolki').value = valueForRolki;

                    // Switch to Rolki tab
                    setTimeout(() => {
                        document.querySelector('.tab-button.active').classList.remove('active');
                        document.querySelectorAll('.tab-button')[1].classList.add('active');
                        document.getElementById('obrazkiTab').classList.remove('active');
                        document.getElementById('rolkiTab').classList.add('active');
                        currentTab = 'rolki';
                        document.getElementById('languageSelectorObrazki').style.display = 'none';
                        document.getElementById('helpButtonObrazki').style.display = 'none';

                        // Focus on the WEIGHT field (not images) so user can immediately enter weight
                        document.getElementById('weightRolki').focus();
                    }, 500);
                }).catch(err => console.error('B≈ÇƒÖd kopiowania:', err));
            },

            renderHistory() {
                const container = document.getElementById('historyContainerObrazki');
                const langDict = this.translations[this.currentLang];

                if (this.history.length === 0) {
                    container.innerHTML = `<div class="empty-history">${langDict.empty_history}</div>`;
                    return;
                }

                container.innerHTML = this.history.map(item => {
                    const wynikDoWyswietlenia = item.wynikKo≈Ñcowy || item.wynik;
                    let wynikHTML = '';

                    if (item.zaokraglono) {
                        const roznica = item.wynikKo≈Ñcowy - item.wynikDok≈Çadny;
                        wynikHTML = `
                            <div class="history-result">
                                ${langDict.history_result_label} ${wynikDoWyswietlenia.toLocaleString('pl-PL')} ${langDict.history_images_unit_single}
                                <span style="font-size: 0.9rem; opacity: 0.7; display: block; margin-top: 0.3rem;">
                                   ${langDict.history_rounded_from} ${item.wynikDok≈Çadny.toLocaleString('pl-PL')} (+${roznica})
                                </span>
                            </div>`;
                    } else {
                        wynikHTML = `<div class="history-result">${langDict.history_result_label} ${wynikDoWyswietlenia.toLocaleString('pl-PL')} ${langDict.history_images_unit_single}</div>`;
                    }

                    if (item.rolki > 1) {
                        wynikHTML += `
                            <div style="margin-top: 0.8rem; padding: 0.8rem; background: rgba(76, 175, 80, 0.1); border-radius: 5px; border-left: 3px solid #4caf50;">
                                <strong style="color: #4caf50;">${langDict.history_total_label} ${item.wynikLacznie.toLocaleString('pl-PL')} ${langDict.history_total_images_unit}</strong>
                                <span style="font-size: 0.9rem; color: var(--text-secondary); display: block; margin-top: 0.2rem;">
                                    (${wynikDoWyswietlenia.toLocaleString('pl-PL')} √ó ${item.rolki} ${langDict.history_total_from_rolls})
                                </span>
                            </div>`;
                    }

                    return `
                        <div class="history-item">
                            <div class="history-item-header">
                                <div class="history-item-time">üìÖ ${item.timestamp}</div>
                                <button class="history-item-delete" onclick="ObrazkiApp.deleteHistoryItem(${item.id})">${langDict.history_delete_button}</button>
                            </div>
                            <div class="history-item-data">
                                <div class="history-data-item">${langDict.history_meters} ${item.metry.toLocaleString('pl-PL')} m</div>
                                <div class="history-data-item">${langDict.history_sleeve} ${item.walek} cm</div>
                                <div class="history-data-item">${langDict.history_motifs} ${item.motywy}</div>
                                ${item.rolki > 1 ? `<div class="history-data-item">${langDict.history_rolls} ${item.rolki}</div>` : ''}
                            </div>
                            ${wynikHTML}
                        </div>`;
                }).join('');
            },

            updateStats() {
                const statToday = this.history.length;
                const statTotal = this.history.reduce((sum, item) => sum + (item.wynikLacznie || item.wynikKo≈Ñcowy || item.wynik || 0), 0);
                const statAvg = this.history.length > 0 ? Math.round(this.history.reduce((sum, item) => sum + item.metry, 0) / this.history.length) : 0;

                document.getElementById('statTodayObrazki').textContent = statToday;
                document.getElementById('statTotalObrazki').textContent = statTotal.toLocaleString('pl-PL');
                document.getElementById('statAvgObrazki').textContent = statAvg.toLocaleString('pl-PL') + ' m';
            },

            deleteHistoryItem(id) {
                if (confirm(this.translations[this.currentLang].confirm_delete_item)) {
                    this.history = this.history.filter(item => item.id !== id);
                    this.saveHistory();
                    this.renderHistory();
                    this.updateStats();
                }
            },

            clearHistory() {
                if (this.history.length === 0) {
                    alert(this.translations[this.currentLang].alert_history_empty);
                    return;
                }

                const confirmMsg = this.translations[this.currentLang].confirm_clear_history.replace('{count}', this.history.length);
                if (confirm(confirmMsg)) {
                    this.history = [];
                    this.saveHistory();
                    this.renderHistory();
                    this.updateStats();
                    document.getElementById('resultBoxObrazki').style.display = 'none';
                    document.getElementById('calculatorFormObrazki').reset();
                    document.getElementById('rolkiObrazki').value = 1;
                }
            }
        };

        function toggleHelpObrazki() {
            const helpBox = document.getElementById('helpBoxObrazki');
            helpBox.style.display = (helpBox.style.display === 'none' || helpBox.style.display === '') ? 'block' : 'none';
        }

        // =================================================================
        // ROLKI APP
        // =================================================================
        class RollTracker {
            constructor() {
                this.rolls = this.loadFromStorage();
                this.palletCustomSizes = this.loadPalletSizes();
                this.orderSettings = this.loadOrderSettings();
                this.currentEditingPalletIndex = null;
                this.initElements();
                this.initOrderElements();
                this.attachEventListeners();
                this.attachOrderEventListeners();
                this.render();
                this.updateProgressBar();
            }

            initElements() {
                this.form = document.getElementById('addRollFormRolki');
                this.weightInput = document.getElementById('weightRolki');
                this.imagesInput = document.getElementById('imagesRolki');
                this.quantityInput = document.getElementById('quantityRolki');
                this.rollsPerPalletInput = document.getElementById('rollsPerPalletRolki');
                this.continuationMode = document.getElementById('continuationModeRolki');
                this.lastRollNumber = document.getElementById('lastRollNumberRolki');
                this.startingPalletNumberInput = document.getElementById('startingPalletNumberRolki');
                this.inheritedRollsCountInput = document.getElementById('inheritedRollsCountRolki');
                this.inheritedRollsWeightInput = document.getElementById('inheritedRollsWeightRolki');
                this.continuationFields = document.getElementById('continuationFields');
                this.rollsList = document.getElementById('rollsListRolki');
                this.totalPallets = document.getElementById('totalPalletsRolki');
                this.totalRolls = document.getElementById('totalRollsRolki');
                this.totalWeight = document.getElementById('totalWeightRolki');
                this.totalImages = document.getElementById('totalImagesRolki');
                this.clearAllBtn = document.getElementById('clearAllBtnRolki');

                this.editPalletModal = document.getElementById('editPalletModalRolki');
                this.editRollsPerPallet = document.getElementById('editRollsPerPalletRolki');
                this.modalPalletInfo = document.getElementById('modalPalletInfoRolki');
                this.cancelEditBtn = document.getElementById('cancelEditBtnRolki');
                this.saveEditBtn = document.getElementById('saveEditBtnRolki');

                this.loadContinuationSettings();
                this.loadPalletSettings();
                this.loadQuantitySettings();
                this.loadConfigCollapsedState();
                this.updateWeightSuggestion();
            }

            initOrderElements() {
                this.orderLengthInput = document.getElementById('orderLengthRolki');
                this.orderUnitSelect = document.getElementById('orderUnitRolki');
                this.orderCompletedInput = document.getElementById('orderCompletedRolki');
                this.continuationOrderFields = document.getElementById('continuationOrderFields');
                this.orderProgressSection = document.getElementById('orderProgressSection');
                this.progressBar = document.getElementById('progressBar');
                this.progressCurrent = document.getElementById('progressCurrent');
                this.progressTotal = document.getElementById('progressTotal');
                this.progressUnit = document.getElementById('progressUnit');
                this.progressPercentage = document.getElementById('progressPercentage');
                this.progressRemaining = document.getElementById('progressRemaining');
                this.progressRemainingUnit = document.getElementById('progressRemainingUnit');

                if (this.orderSettings.length) {
                    this.orderLengthInput.value = this.orderSettings.length;
                }
                if (this.orderSettings.unit) {
                    this.orderUnitSelect.value = this.orderSettings.unit;
                }
                if (this.orderSettings.completed) {
                    this.orderCompletedInput.value = this.orderSettings.completed;
                }
            }

            attachEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                this.clearAllBtn.addEventListener('click', () => this.clearAll());
                this.continuationMode.addEventListener('change', (e) => this.handleContinuationToggle(e));
                this.lastRollNumber.addEventListener('change', () => {
                    this.saveContinuationSettings();
                    updateConfigSummary();
                });
                this.startingPalletNumberInput.addEventListener('change', () => {
                    this.saveContinuationSettings();
                    updateConfigSummary();
                    this.render();
                });
                this.inheritedRollsCountInput.addEventListener('change', () => {
                    this.saveContinuationSettings();
                    updateConfigSummary();
                });
                this.inheritedRollsWeightInput.addEventListener('change', () => {
                    this.saveContinuationSettings();
                    updateConfigSummary();
                });
                this.quantityInput.addEventListener('change', () => {
                    this.saveQuantitySettings();
                    updateConfigSummary();
                    this.updateWeightSuggestion();
                });
                this.rollsPerPalletInput.addEventListener('change', () => {
                    this.savePalletSettings();
                    updateConfigSummary();
                });

                this.imagesInput.addEventListener('input', () => {
                    this.updateWeightSuggestion();
                });

                this.cancelEditBtn.addEventListener('click', () => this.closeEditModal());
                this.saveEditBtn.addEventListener('click', () => this.saveEditPallet());
                this.editPalletModal.addEventListener('click', (e) => {
                    if (e.target === this.editPalletModal) {
                        this.closeEditModal();
                    }
                });
            }

            attachOrderEventListeners() {
                this.orderLengthInput.addEventListener('change', () => {
                    this.saveOrderSettings();
                    this.updateContinuationOrderVisibility();
                    this.updateProgressBar();
                    updateConfigSummary();
                });

                this.orderUnitSelect.addEventListener('change', () => {
                    this.saveOrderSettings();
                    this.updateProgressBar();
                    updateConfigSummary();
                });

                this.orderCompletedInput.addEventListener('change', () => {
                    this.saveOrderSettings();
                    this.updateProgressBar();
                });
            }

            handleContinuationToggle(e) {
                if (e.target.checked) {
                    this.continuationFields.classList.add('visible');
                } else {
                    this.continuationFields.classList.remove('visible');
                }
                this.saveContinuationSettings();
                this.updateContinuationOrderVisibility();
                updateConfigSummary();
                this.render();
            }

            saveContinuationSettings() {
                const settings = {
                    isContinuation: this.continuationMode.checked,
                    lastRollNumber: parseInt(this.lastRollNumber.value) || 0,
                    startingPalletNumber: parseInt(this.startingPalletNumberInput.value) || 1,
                    inheritedRollsCount: parseInt(this.inheritedRollsCountInput.value) || 0,
                    inheritedRollsWeight: parseFloat(this.inheritedRollsWeightInput.value) || 0
                };
                localStorage.setItem('rolki_continuationSettings', JSON.stringify(settings));
            }

            loadContinuationSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('rolki_continuationSettings'));
                    if (settings) {
                        this.continuationMode.checked = settings.isContinuation;
                        this.lastRollNumber.value = settings.lastRollNumber || 0;
                        this.startingPalletNumberInput.value = settings.startingPalletNumber || 1;
                        this.inheritedRollsCountInput.value = settings.inheritedRollsCount || 0;
                        this.inheritedRollsWeightInput.value = settings.inheritedRollsWeight || 0;
                        if (settings.isContinuation) {
                            this.continuationFields.classList.add('visible');
                        }
                    }
                } catch (e) {
                    console.error('B≈ÇƒÖd wczytywania ustawie≈Ñ kontynuacji:', e);
                }
            }

            loadConfigCollapsedState() {
                try {
                    const isCollapsed = localStorage.getItem('rolki_configCollapsed') === 'true';
                    if (isCollapsed) {
                        document.getElementById('configBody').classList.add('collapsed');
                        document.getElementById('configArrow').classList.add('rotated');
                    }
                    updateConfigSummary();
                } catch (e) {
                    console.error('B≈ÇƒÖd wczytywania stanu panelu konfiguracji:', e);
                }
            }

            savePalletSettings() {
                const settings = {
                    rollsPerPallet: parseInt(this.rollsPerPalletInput.value) || 3
                };
                localStorage.setItem('rolki_palletSettings', JSON.stringify(settings));
                this.render();
            }

            loadPalletSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('rolki_palletSettings'));
                    if (settings) {
                        this.rollsPerPalletInput.value = settings.rollsPerPallet;
                    }
                } catch (e) {
                    console.error('B≈ÇƒÖd wczytywania ustawie≈Ñ palet:', e);
                }
            }

            saveQuantitySettings() {
                const quantity = parseInt(this.quantityInput.value) || 1;
                localStorage.setItem('rolki_quantitySettings', quantity.toString());
            }

            loadQuantitySettings() {
                try {
                    const quantity = localStorage.getItem('rolki_quantitySettings');
                    if (quantity) {
                        this.quantityInput.value = parseInt(quantity);
                    }
                } catch (e) {
                    console.error('B≈ÇƒÖd wczytywania ustawie≈Ñ ilo≈õci:', e);
                }
            }

            saveOrderSettings() {
                const settings = {
                    length: parseFloat(this.orderLengthInput.value) || 0,
                    unit: this.orderUnitSelect.value,
                    completed: parseFloat(this.orderCompletedInput.value) || 0
                };
                localStorage.setItem('rolki_orderSettings', JSON.stringify(settings));
                this.orderSettings = settings;
            }

            loadOrderSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('rolki_orderSettings'));
                    return settings || { length: 0, unit: 'images', completed: 0 };
                } catch (e) {
                    return { length: 0, unit: 'images', completed: 0 };
                }
            }

            updateContinuationOrderVisibility() {
                const hasOrderLength = parseFloat(this.orderLengthInput.value) > 0;
                const isContinuation = this.continuationMode.checked;

                if (hasOrderLength && isContinuation) {
                    this.continuationOrderFields.style.display = 'block';
                } else {
                    this.continuationOrderFields.style.display = 'none';
                }
            }

            loadPalletSizes() {
                try {
                    const sizes = localStorage.getItem('rolki_palletCustomSizes');
                    return sizes ? JSON.parse(sizes) : {};
                } catch (e) {
                    console.error('B≈ÇƒÖd wczytywania rozmiar√≥w palet:', e);
                    return {};
                }
            }

            savePalletSizes() {
                try {
                    localStorage.setItem('rolki_palletCustomSizes', JSON.stringify(this.palletCustomSizes));
                } catch (e) {
                    console.error('B≈ÇƒÖd zapisu rozmiar√≥w palet:', e);
                }
            }

            handleSubmit(e) {
                e.preventDefault();

                const weight = parseFloat(this.weightInput.value);
                const images = parseInt(this.imagesInput.value) || 0;
                const quantity = parseInt(this.quantityInput.value) || 1;

                if (!weight || weight <= 0) {
                    alert('Proszƒô wprowadziƒá prawid≈ÇowƒÖ wagƒô');
                    return;
                }

                if (quantity <= 0) {
                    alert('Ilo≈õƒá rolek musi byƒá wiƒôksza ni≈º 0');
                    return;
                }

                const wasEmpty = this.rolls.length === 0;

                for (let i = 0; i < quantity; i++) {
                    this.addRoll(weight, images);
                }

                this.weightInput.value = '';
                this.imagesInput.value = '';
                this.weightInput.placeholder = 'np. 125.5';
                this.weightInput.classList.remove('has-suggestion');
                this.weightInput.focus();

                this.saveToStorage();
                this.render();

                // Auto-zwi≈Ñ panel po dodaniu pierwszej rolki
                if (wasEmpty && this.rolls.length > 0) {
                    const configBody = document.getElementById('configBody');
                    const configArrow = document.getElementById('configArrow');
                    if (!configBody.classList.contains('collapsed')) {
                        configBody.classList.add('collapsed');
                        configArrow.classList.add('rotated');
                        localStorage.setItem('rolki_configCollapsed', 'true');
                    }
                }
            }

            addRoll(weight, images) {
                const roll = {
                    id: Date.now() + Math.random(),
                    weight: weight,
                    images: images,
                    timestamp: new Date().toISOString()
                };
                this.rolls.push(roll);
            }

            calculateSuggestedWeight(images) {
                if (!images || images <= 0) {
                    return null;
                }

                const rollsPerCut = parseInt(this.quantityInput.value) || 1;
                const minRolls = 3 * rollsPerCut;

                const validRolls = this.rolls.filter(roll =>
                    roll.weight > 0 && roll.images > 0
                );

                if (validRolls.length < minRolls) {
                    return null;
                }

                const ratios = validRolls.map(roll => roll.weight / roll.images);

                const cleanedRatios = this.removeOutliers(ratios);

                if (cleanedRatios.length < minRolls) {
                    return null;
                }

                const avgRatio = cleanedRatios.reduce((sum, r) => sum + r, 0) / cleanedRatios.length;

                const suggestedWeight = Math.round(images * avgRatio);

                return suggestedWeight;
            }

            removeOutliers(values) {
                if (values.length < 3) {
                    return values;
                }

                const mean = values.reduce((sum, v) => sum + v, 0) / values.length;

                const squaredDiffs = values.map(v => Math.pow(v - mean, 2));
                const avgSquaredDiff = squaredDiffs.reduce((sum, v) => sum + v, 0) / values.length;
                const stdDev = Math.sqrt(avgSquaredDiff);

                const lowerBound = mean - (2 * stdDev);
                const upperBound = mean + (2 * stdDev);

                return values.filter(v => v >= lowerBound && v <= upperBound);
            }

            updateWeightSuggestion() {
                const images = parseInt(this.imagesInput.value) || 0;
                const suggestedWeight = this.calculateSuggestedWeight(images);

                if (suggestedWeight !== null && suggestedWeight > 0) {
                    this.weightInput.placeholder = `sugestia: ~${suggestedWeight} kg`;
                    this.weightInput.classList.add('has-suggestion');
                } else {
                    this.weightInput.placeholder = 'np. 125.5';
                    this.weightInput.classList.remove('has-suggestion');
                }
            }

            deleteRoll(id) {
                if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô rolkƒô?')) {
                    this.rolls = this.rolls.filter(roll => roll.id !== id);
                    this.saveToStorage();
                    this.render();
                }
            }

            clearAll() {
                if (confirm('Czy na pewno chcesz usunƒÖƒá wszystkie rolki? Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
                    this.rolls = [];
                    this.palletCustomSizes = {};
                    this.orderLengthInput.value = '';
                    this.orderCompletedInput.value = '0';
                    this.saveToStorage();
                    this.savePalletSizes();
                    this.saveOrderSettings();
                    this.render();
                    this.updateProgressBar();
                }
            }

            openEditPalletModal(palletIndex, currentSize) {
                this.currentEditingPalletIndex = palletIndex;
                this.editRollsPerPallet.value = currentSize;
                this.modalPalletInfo.textContent = `Paleta #${palletIndex + 1} (obecnie ${currentSize} rolek)`;
                this.editPalletModal.classList.add('show');
            }

            closeEditModal() {
                this.editPalletModal.classList.remove('show');
                this.currentEditingPalletIndex = null;
            }

            saveEditPallet() {
                const newSize = parseInt(this.editRollsPerPallet.value);
                if (!newSize || newSize < 1) {
                    alert('Liczba rolek musi byƒá wiƒôksza ni≈º 0');
                    return;
                }

                this.palletCustomSizes[this.currentEditingPalletIndex] = newSize;
                this.savePalletSizes();
                this.closeEditModal();
                this.render();
            }

            calculateSummary() {
                const totalRolls = this.rolls.length;
                const totalWeight = this.rolls.reduce((sum, roll) => sum + roll.weight, 0);
                const totalImages = this.rolls.reduce((sum, roll) => sum + roll.images, 0);

                const pallets = this.groupIntoPallets();
                const totalPallets = pallets.length;

                return { totalRolls, totalWeight, totalImages, totalPallets };
            }

            groupIntoPallets() {
                if (this.rolls.length === 0) return [];

                const sortedRolls = [...this.rolls].sort((a, b) =>
                    new Date(a.timestamp) - new Date(b.timestamp)
                );

                const defaultRollsPerPallet = parseInt(this.rollsPerPalletInput.value) || 3;
                const isContinuation = this.continuationMode.checked;
                const startingPalletNumber = parseInt(this.startingPalletNumberInput.value) || 1;
                const inheritedCount = parseInt(this.inheritedRollsCountInput.value) || 0;
                const inheritedWeight = parseFloat(this.inheritedRollsWeightInput.value) || 0;

                const pallets = [];
                // Zaczynamy od numeru palety minus 1 (bo indeksy zaczynajƒÖ siƒô od 0)
                let currentPalletIndex = isContinuation ? (startingPalletNumber - 1) : 0;
                let rollIndex = 0;

                // Pierwsza paleta w trybie kontynuacji
                if (rollIndex === 0 && isContinuation) {
                    const firstPalletSize = this.palletCustomSizes[currentPalletIndex] || defaultRollsPerPallet;

                    if (inheritedCount > 0) {
                        // Paleta z odziedziczonymi rolkami - ograniczona przestrze≈Ñ
                        const availableSpace = Math.max(0, firstPalletSize - inheritedCount);
                        const firstPalletRolls = sortedRolls.slice(0, availableSpace);

                        pallets.push({
                            index: currentPalletIndex,
                            rolls: firstPalletRolls,
                            size: firstPalletSize,
                            inheritedCount: inheritedCount,
                            inheritedWeight: inheritedWeight
                        });

                        rollIndex = availableSpace;
                        currentPalletIndex++;
                    } else {
                        // Paleta pusta - pe≈Çna przestrze≈Ñ dostƒôpna
                        const firstPalletRolls = sortedRolls.slice(0, firstPalletSize);

                        pallets.push({
                            index: currentPalletIndex,
                            rolls: firstPalletRolls,
                            size: firstPalletSize
                        });

                        rollIndex = firstPalletSize;
                        currentPalletIndex++;
                    }
                }

                // Pozosta≈Çe palety
                while (rollIndex < sortedRolls.length) {
                    const palletSize = this.palletCustomSizes[currentPalletIndex] || defaultRollsPerPallet;
                    const palletRolls = sortedRolls.slice(rollIndex, rollIndex + palletSize);

                    if (palletRolls.length > 0) {
                        pallets.push({
                            index: currentPalletIndex,
                            rolls: palletRolls,
                            size: palletSize
                        });
                    }

                    rollIndex += palletSize;
                    currentPalletIndex++;
                }

                return pallets;
            }

            render() {
                const { totalRolls, totalWeight, totalImages, totalPallets } = this.calculateSummary();
                this.totalPallets.textContent = totalPallets;
                this.totalRolls.textContent = totalRolls;
                this.totalWeight.textContent = totalWeight.toFixed(2);
                this.totalImages.textContent = totalImages;

                if (totalRolls > 0) {
                    this.clearAllBtn.style.display = 'block';
                } else {
                    this.clearAllBtn.style.display = 'none';
                }

                if (this.rolls.length === 0) {
                    this.rollsList.innerHTML = '<p class="empty-message">Brak rolek. Dodaj pierwszƒÖ rolkƒô powy≈ºej.</p>';
                    return;
                }

                const pallets = this.groupIntoPallets();

                const isContinuation = this.continuationMode.checked;
                const lastRoll = parseInt(this.lastRollNumber.value) || 0;

                let globalRollIndex = 0;
                pallets.forEach(pallet => {
                    pallet.rolls = pallet.rolls.map(roll => {
                        const shiftNumber = globalRollIndex + 1;
                        const orderNumber = isContinuation ? lastRoll + globalRollIndex + 1 : globalRollIndex + 1;
                        globalRollIndex++;

                        return {
                            ...roll,
                            shiftNumber: shiftNumber,
                            orderNumber: orderNumber,
                            isContinuation: isContinuation
                        };
                    });
                });

                const palletsForDisplay = [...pallets].reverse();

                this.rollsList.innerHTML = palletsForDisplay.map(pallet => this.createPalletElement(pallet)).join('');

                this.rollsList.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseFloat(e.target.dataset.id);
                        this.deleteRoll(id);
                    });
                });

                this.rollsList.querySelectorAll('.btn-edit-pallet').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const palletIndex = parseInt(e.target.dataset.palletIndex);
                        const currentSize = parseInt(e.target.dataset.currentSize);
                        this.openEditPalletModal(palletIndex, currentSize);
                    });
                });

                this.updateProgressBar();
                this.updateWeightSuggestion();
            }

            updateProgressBar() {
                const orderLength = parseFloat(this.orderLengthInput.value) || 0;
                const orderUnit = this.orderUnitSelect.value;
                const orderCompleted = parseFloat(this.orderCompletedInput.value) || 0;

                if (orderLength <= 0) {
                    this.orderProgressSection.style.display = 'none';
                    return;
                }

                this.orderProgressSection.style.display = 'block';

                let currentProgress = orderCompleted;

                if (orderUnit === 'images') {
                    currentProgress += this.rolls.reduce((sum, roll) => sum + (roll.images || 0), 0);
                } else {
                    currentProgress += this.rolls.reduce((sum, roll) => sum + roll.weight, 0);
                }

                const percentage = Math.min((currentProgress / orderLength) * 100, 100);
                const remaining = Math.max(orderLength - currentProgress, 0);

                const unitText = orderUnit === 'images' ? 'obrazk√≥w' : 'kg';
                this.progressCurrent.textContent = this.formatNumber(currentProgress);
                this.progressTotal.textContent = this.formatNumber(orderLength);
                this.progressUnit.textContent = unitText;
                this.progressPercentage.textContent = `(${percentage.toFixed(1)}%)`;
                this.progressRemaining.innerHTML = `Pozosta≈Ço: <strong>${this.formatNumber(remaining)}</strong>`;
                this.progressRemainingUnit.textContent = unitText;

                this.progressBar.style.width = `${percentage}%`;

                this.progressBar.classList.remove('warning-70', 'warning-80', 'warning-90', 'complete');

                if (percentage >= 100) {
                    this.progressBar.classList.add('complete');
                } else if (percentage >= 90) {
                    this.progressBar.classList.add('warning-90');
                } else if (percentage >= 80) {
                    this.progressBar.classList.add('warning-80');
                } else if (percentage >= 70) {
                    this.progressBar.classList.add('warning-70');
                }
            }

            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(2) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'k';
                }
                return num.toFixed(num % 1 === 0 ? 0 : 2);
            }

            createPalletElement(pallet) {
                const palletWeight = pallet.rolls.reduce((sum, roll) => sum + roll.weight, 0);
                const palletImages = pallet.rolls.reduce((sum, roll) => sum + roll.images, 0);

                // Uwzglƒôdnij odziedziczone rolki w wadze i ilo≈õci
                const totalPalletWeight = palletWeight + (pallet.inheritedWeight || 0);
                const totalRollCount = pallet.rolls.length + (pallet.inheritedCount || 0);

                // Odwr√≥ƒá kolejno≈õƒá rolek w palecie - najnowsze na g√≥rze
                const reversedRolls = [...pallet.rolls].reverse();
                const rollsHtml = reversedRolls.map(roll => this.createRollElement(roll)).join('');

                // Sekcja odziedziczonych rolek (tylko dla pierwszej palety)
                let inheritedSection = '';
                if (pallet.inheritedCount && pallet.inheritedCount > 0) {
                    inheritedSection = `
                        <div class="inherited-rolls">
                            <div class="inherited-label">üì• Z poprzedniej zmiany:</div>
                            <div class="inherited-info">${pallet.inheritedCount} rolek ‚Ä¢ ${pallet.inheritedWeight.toFixed(2)} kg</div>
                        </div>
                    `;
                }

                return `
                    <div class="pallet-container">
                        <div class="pallet-header" onclick="togglePallet(this)">
                            <div>
                                <div class="pallet-title">
                                    <span class="pallet-icon">üì¶</span>
                                    <span>Paleta #${pallet.index + 1}</span>
                                    <span class="pallet-toggle-arrow collapsed">‚ñº</span>
                                </div>
                                <div class="pallet-summary">
                                    <div class="pallet-stat">
                                        <span>Rolek: <strong>${totalRollCount}</strong></span>
                                    </div>
                                    <div class="pallet-stat">
                                        <span>Waga: <strong>${totalPalletWeight.toFixed(2)} kg</strong></span>
                                    </div>
                                    ${palletImages > 0 ? `
                                        <div class="pallet-stat">
                                            <span>Obrazki: <strong>${palletImages}</strong></span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="pallet-actions" onclick="event.stopPropagation()">
                                <button
                                    class="btn-edit-pallet"
                                    data-pallet-index="${pallet.index}"
                                    data-current-size="${pallet.rolls.length}">
                                    Edytuj
                                </button>
                            </div>
                        </div>
                        <div class="pallet-rolls collapsed">
                            ${inheritedSection}
                            ${rollsHtml}
                        </div>
                    </div>
                `;
            }

            createRollElement(roll) {
                const date = new Date(roll.timestamp);
                const timeString = date.toLocaleTimeString('pl-PL', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let rollNumberText;
                if (roll.isContinuation) {
                    rollNumberText = `
                        <div class="roll-number-dual">
                            <span class="order-number">Rolka (zlecenie): #${roll.orderNumber}</span>
                            <span class="shift-number">Rolka (zmiana): #${roll.shiftNumber}</span>
                        </div>
                    `;
                } else {
                    rollNumberText = `<div class="roll-number">Rolka #${roll.orderNumber}</div>`;
                }

                return `
                    <div class="roll-item">
                        <div class="roll-info">
                            ${rollNumberText}
                            <div class="roll-details">
                                <div class="roll-detail">
                                    <strong>Waga:</strong> ${roll.weight.toFixed(2)} kg
                                </div>
                                ${roll.images > 0 ? `
                                    <div class="roll-detail">
                                        <strong>Obrazki:</strong> ${roll.images}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="roll-time">Dodano: ${timeString}</div>
                        </div>
                        <div class="roll-actions">
                            <button class="btn-delete" data-id="${roll.id}">
                                Usu≈Ñ
                            </button>
                        </div>
                    </div>
                `;
            }

            saveToStorage() {
                try {
                    localStorage.setItem('rolki_rollTrackerData', JSON.stringify(this.rolls));
                } catch (e) {
                    console.error('B≈ÇƒÖd zapisu do localStorage:', e);
                    alert('Nie uda≈Ço siƒô zapisaƒá danych. Sprawd≈∫ ustawienia przeglƒÖdarki.');
                }
            }

            loadFromStorage() {
                try {
                    const data = localStorage.getItem('rolki_rollTrackerData');
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('B≈ÇƒÖd odczytu z localStorage:', e);
                    return [];
                }
            }
        }

        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadCurrentTab();
            ObrazkiApp.loadHistory();
            ObrazkiApp.loadLanguage();
            ObrazkiApp.loadConfig();
            ObrazkiApp.updateStats();
            new RollTracker();

            // Event listenery dla automatycznego zapisywania konfiguracji
            document.getElementById('walekObrazki').addEventListener('change', () => ObrazkiApp.saveConfig());
            document.getElementById('motywyObrazki').addEventListener('change', () => ObrazkiApp.saveConfig());
            document.getElementById('rolkiObrazki').addEventListener('change', () => ObrazkiApp.saveConfig());
            document.getElementById('zaokraglajObrazki').addEventListener('change', () => ObrazkiApp.saveConfig());

            // Wczytaj stan zwiniƒôcia panelu konfiguracji Obrazki
            const obrazkiCollapsed = localStorage.getItem('obrazki_configCollapsed') === 'true';
            if (obrazkiCollapsed) {
                document.getElementById('configBodyObrazki').classList.add('collapsed');
                document.getElementById('configArrowObrazki').classList.add('rotated');
            }
            updateConfigSummaryObrazki();

            // Nas≈Çuchuj zmian w polach konfiguracji Obrazki
            ['walekObrazki', 'motywyObrazki', 'rolkiObrazki'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateConfigSummaryObrazki);
            });
        });
    </script>
</body>
</html>
